// Nextflow flags
nextflow.enable.moduleBinaries = true

// Pipeline parameters
params {
    // required input params
    sample_table     = null
    celltypes        = null
    pseudobulk_peaks = null
    atac_adata       = null
    callPeaks        = null
    inferConsensus   = null
    attachGEX        = null
    chromsizes       = "${projectDir}/reference/hg38.chrom.sizes"
    blacklist        = "${projectDir}/reference/hg38-blacklist.v2.bed"
    tss_bed          = "${projectDir}/reference/hg38_pycistopic_tss.bed"

    // optional params
    help         = false
    output_dir   = 'results'
    publish_mode = 'link'

    // pyCISTOPIC params
    cistopic {
        // pseudobulking
        normalize_bigwig = true
        // peak calling
        specie           = 'hs'
        input_format     = 'BEDPE'
        shift            = 73
        extend_read_size = 146
        keep_duplicates  = 'all'
        q_value_cutoff   = 0.05
        // consensus
        peak_half_width = 250
        // quality control
        tss_flank_window             = 2000
        tss_smoothing_rolling_window = 10
        tss_window                   = 50
        tss_min_norm                 = 0.2
        min_fragments_per_cb         = 10
        use_pyranges                 = false
        dont_collapse_duplicates     = false
        // create object
        min_frag                 = 1
        min_cell                 = 1
        is_acc                   = 1
        split_pattern            = '___'
        check_for_duplicates     = true
        use_automatic_thresholds = true
    }
}

// Unscoped options
outputDir = params.output_dir
cleanup   = false
workDir   = "nf-work"

process {
    queue         = 'normal'
    maxRetries    = 5
    errorStrategy = { task.exitStatus in 130..140 ? lowResourceError(task.process) : 'finish' }
}

// Load config for cisTopic component
includeConfig 'configs/cistopic_countfragments.config'
includeConfig 'configs/cistopic_splitannotation.config'
includeConfig 'configs/cistopic_pseudobulk.config'
includeConfig 'configs/cistopic_callpeaks.config'
includeConfig 'configs/cistopic_inferconsensus.config'
includeConfig 'configs/cistopic_qualitycontrol.config'
includeConfig 'configs/cistopic_createobject.config'
includeConfig 'configs/cistopic_combineobjects.config'
includeConfig 'configs/anndata_concat.config'
includeConfig 'configs/anndata_attachcelltypes.config'
includeConfig 'configs/anndata_couplemultiome.config'
includeConfig 'configs/anndata_toh5ad.config'

singularity {
    enabled     = true
    autoMounts  = true
    pullTimeout = '120m'
    runOptions  = '-B /lustre,/nfs'
    cacheDir    = '/nfs/cellgeni/singularity/images/'
}

executor {
    name           = 'lsf'
    perJobMemLimit = true
}

// Capturing Nextflow log files into a 'reports' directory
import java.time.*
Date now = new Date()

params {
    tracedir  = "reports"
    timestamp = now.format("yyyyMMdd-HH-mm-ss")
}

timeline {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_timeline.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_report.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_trace.tsv"
}

// Manifest
manifest {
  name            = 'cellgeni/nf-atac'
  homePage        = 'https://github.com/cellgeni/nf-atac'
  description     = "Nextflow pipeline for single-cell ATAC-seq data processing and analysis"
  mainScript      = 'main.nf'
  nextflowVersion = '!>=25.04.4'
  version         = '25-280'
  defaultBranch   = 'main'
  contributors    = [
    [
      name: 'Aljes Binkevich',
      email: 'ab76@sanger.ac.uk',
      github: 'claptar',
      contribution: ['author', 'maintainer', 'contributor'],
    ],
    [
      name: 'Pavel Mazin',
      email: 'pm19@sanger.ac.uk',
      github: 'iaaka',
      contribution: ['author', 'maintainer', 'contributor'],
    ],
  ]
}