
// nextflow flags
nextflow.enable.moduleBinaries = true

// workflow marapeters
params {
    // process params
    output_dir               = "results"
    publish_mode             = 'link'
    fragments_filename       = 'atac_fragments.tsv.gz'
    barcode_metrics_filename = "per_barcode_metrics.csv"
    pseudobulk_table_name    = "pseudobulk_table.csv"
    narrowPeaks_dir          = 'narrowPeaks'

    // input arguments
    help           = false
    sample_table   = null
    celltypes      = null
    callPeaks      = null
    inferConsensus = null

    // reference files
    chromsizes = "${projectDir}/reference/hg38.chrom.sizes"
    blacklist  = "${projectDir}/reference/hg38-blacklist.v2.bed"
    tss_bed    = "${projectDir}/reference/hg38_pycistopic_tss.bed"
}

process {
    queue         = 'normal'
    maxRetries    = 5
    errorStrategy = { task.exitStatus in 130..140 ? lowResourceError(meta.id, task.process) : 'finish' }
    container     = '/nfs/cellgeni/singularity/images/scenicplus-fa55dae.sif'
}

// Load config for cisTopic component
includeConfig 'modules/local/cistopic/countfragments/module.config'
includeConfig 'modules/local/cistopic/splitannotation/module.config'
includeConfig 'modules/local/cistopic/pseudobulk/module.config'
includeConfig 'modules/local/cistopic/callpeaks/module.config'
includeConfig 'modules/local/cistopic/inferconsensus/module.config'
includeConfig 'modules/local/cistopic/qualitycontrol/module.config'
includeConfig 'modules/local/cistopic/createobject/module.config'
includeConfig 'modules/local/cistopic/combineobjects/module.config'
includeConfig 'modules/local/anndata/concat/module.config'

singularity {
    enabled    = true
    autoMounts = true
    runOptions = '-B /lustre,/nfs'
    cacheDir   = '/nfs/cellgeni/singularity/images/'
}

executor {
    name           = 'lsf'
    perJobMemLimit = true
}

// Capturing Nextflow log files into a 'reports' directory
import java.time.*
Date now = new Date()

params {
    tracedir  = "reports"
    timestamp = now.format("yyyyMMdd-HH-mm-ss")
}

timeline {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_timeline.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_report.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/${params.timestamp}_trace.tsv"
}

// Unscoped options
outputDir = params.output_dir
cleanup   = false
workDir   = "nf-work"